# Kiro（帰路）パズルゲーム ルール説明

## 基本ルール

### ゲームの基本的な流れ
1. **パネル配置**: グリッド上にパネルを配置してマスの状態を変更
2. **Playボタン**: 実行すると自動でルート探索が開始される
3. **プレイヤー移動**: 最適な経路でゴールを目指す

### マスの通行ルール
- **Normal（通常床）**: 
  - `front`（白面）: 通行可能
  - `back`（黒面）: 通行不可
- **パネルによる反転**: パネルの黒セルが配置されたNormalマスは面が反転する
- **通行可能条件**: Empty（空）セル以外で、`back`状態でないセル

### パネルシステム
- **パネル構成**: 白（White）と黒（Black）のセルで構成される様々な形状のピース
- **黒セルの機能**: Normalマスに配置すると、そのマスの`front`/`back`状態を反転させる
- **白セルの機能**: 機能なし（空のセル）
- **配置制限**: 黒セルはNormalタイプのマスにのみ配置可能

### ゲーム目的
- **Start（スタート）地点** から **Goal（ゴール）地点** まで移動する

### クリア条件
- Crow: すべて通過してゴール
- DummyGoal: 到達してはいけない
- Wolf: 1匹もGoalに到達させない

### 自動ルート探索
- **探索アルゴリズム**: BFS（幅優先探索）による最短経路探索
- **優先順位**: 
  1. 最短経路（移動数最小）
  2. ゴール種別（Goal > DummyGoal > Rest > Flag）
  3. Crow通過数（多い順）
- プレイヤーとWolfが同時に経路探索を実行

## 経路探索の優先順位

1. **最短経路**: より少ない移動回数の経路
2. **ゴール優先**: Goal > DummyGoal の順
3. **Crow収集**: より多くのCrowを通過する経路

## 判定結果

- **HasClearPath**: クリア可能な経路が存在
- **HasFailPath**: 経路は存在するがクリア不可能（DummyGoalまたはCrow未収集）
- **NoPath**: 到達可能な経路が存在しない
- **NoStart**: Startが存在しない
- **NoGoal**: Goalが存在しない

### クリア条件
1. Goal地点に到達する
2. ステージ内の全Crowを通過済みである
3. Wolfより先にGoalに到達する

### ゲームオーバー条件
- DummyGoal（ダミーゴール）に到達した場合
- Goalに到達したが、全Crowを通過していない場合
- Wolfが先にGoalに到達した場合

## 特殊ギミック

### Rest（休憩地点）
- Rest到達時にパネル配置がリセット
- キャラがその場所にとどまった状態でパネル選択フェーズが再度開始される
  - フェーズ履歴の概念が必要になる：1フェーズでパネル配置した履歴

#### 戦略
- 初期位置の変更
- Crowを取るための中継地点として使える
- 2つのRestがあれば実質ループが可能

## セルタイプとギミック

### 基本セル

#### Start（スタート）
- **表示**: 緑色
- **機能**: プレイヤーの開始地点
- **ルール**: 各ステージに1つ必須

#### Goal（ゴール）  
- **表示**: 青色
- **機能**: 真のクリア地点
- **ルール**: 全Crow通過後に到達でクリア

#### DummyGoal（ダミーゴール）
- **表示**: 赤色
- **機能**: 偽のゴール地点
- **ルール**: 到達すると即ゲームオーバー

#### Normal（通常床）
- **表示**: グレー色
- **機能**: 通常のセル。唯一反転することができる
- **サイド状態**:
  - `front`: 白い床（移動可）
  - `back`: 黒い床（移動不可）

#### Empty（空）
- **表示**: 白色
- **機能**: 移動不可能な空間
- **ルール**: 通過できない

### 特殊ギミック

#### Crow（カラス）
- **表示**: 黒色
- **機能**: 収集対象
- **ルール**: 
  - ステージ内の全Crowを通過する必要がある
  - 通過すると Normal:front に変化する
  - 未通過のCrowがある状態でGoalに到達するとゲームオーバー

#### Wolf（オオカミ）
- **表示**: グレー色
- **機能**: ゴールを目指す敵
- **ルール**:
  - プレイヤーと同じくGoal,Dummygoalを目指して移動する（経路がなければ）
  - 1匹でもGoalに到達すると即ゲームオーバー
- **攻略戦略**:
  - パネル配置でオオカミの道を塞ぐ（NoPathにする）
  - DummyGoalへ誘導

#### Rest（休憩地点）
- **表示**: 黄色  
- **機能**: フェーズ切り替え地点
- **ルール**:
  - 到達した瞬間にフェーズが増加する
  - 到達した瞬間に全パネル配置がリセットされる
  - プレイヤーはそのRest地点から新たに開始する
  - Rest地点が新しいStartとして機能する

#### Trauma（トラウマ）
- **表示**: 紫色
- **機能**: ワープ地点
- **ルール**:
  - 詳細な動作は実装によって異なる

#### Flip（反転）
- **表示**: 黒色
- **機能**: パネル面反転
- **ルール**: 通過時にパネルのfront/back状態を反転させる

#### Flag（フラグ）
- **表示**: グレー色
- **機能**: 特殊な目標地点
- **ルール**: 
  - プレイヤーが到達可能な目標の一つ
  - Flag到達時に次の状態（nextGrid）が生成され、新しいフェーズが開始される
  - 到達したFlagは新しいStartに置き換えられる
  - 元のStartはNormal:front（通常床・白面）に変化する
  - 通過したCrowはNormal:front（通常床・白面）に変化する
  - パネルのfront/back状態はリセットされない（Restとは異なる）
  - ソルバーでは最初のフェーズのグリッドのみがフェーズ履歴に記録される
- **探索優先度**: Goal > DummyGoal > Rest > Flag（最も低い優先度）
- **戦略的用途**: 
  - **位置変更**: プレイヤーの開始位置を変更して新しいルートを開く
  - **Crow収集の中継点**: 直接取れないCrowへのアクセスルートを作成
  - **迂回ルート作成**: 元Start位置が通行可能になることで新たな経路が開ける
  - **柔軟な戦略**: Restと違いパネル状態を保持するため段階的な攻略が可能

- **具体例**:
  ```
  URL: http://localhost:5173/stage?cells=h4w4gcwwewwwgwswwewww&panels=h2w2gbbwb_h1w1gf
  
  【フェーズ1: パネル配置】
  Initial: c w w e
           w w w g  
           w s w w
           e w w w
  
  配置後: c [F] w e      ← Flagパネル(1,0)配置
          w [■][■] g    ← 2x2パネル(1,1)配置: [■]=back(黒・通行不可)
          w [ ][■] w    ← [ ]=white(白セル・何もしない)
          e w w w
  
  【フェーズ1: 経路探索】
  Start(1,2) → (1,1)[■] → (2,1)[■] → Flag(1,0)
  
  【フェーズ2: Flag効果発動】
  変化後: c [S] w e      ← Flag→Start変換
          w [■][■] g    ← パネル状態保持
          w [ ][■] w    
          e w w w       ← 元Start(1,2)→Normal:front(白)変換
  
  【フェーズ2: 最終経路探索】
  足跡付き: c [S] w e      ← 新Start位置
           w [■][■] g    ← [■]=黒(通行不可)なので迂回
           w [1][■] w    ← 1: 元Start位置(白・通行可)
           e [2][3][4]   ← 2,3,4: 迂回ルート
  
  経路: 新Start(1,0) → (1,2)①白 → (1,3)②白 → (2,3)③白 → (3,3)④白 → (3,1)Goal
  ```


## パネルシステム



## ソルバーシステム

### 自動解法機能
- `solveSingle`: 1つの解を探索
- `solveAll`: 全ての解を探索  
- `solvePuzzle`: API形式で解を返す

### 解法制約
- 全パネル使用 (`allowSkip=false`)
- パネル省略可能 (`allowSkip=true`)